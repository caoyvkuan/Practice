<!DOCTYPE html>
<html lang="ZH-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>mineSweeping</title>
  <style>
    html, body { width: 100%; height: 100%; }
    body, main, nav, div, img, button, p, label, ul, li, h1, h2, h3, h4, h5, h6, *::before, *::after { box-sizing: border-box; }
    img { display: block; }
    body, ul, li, p, h1, h2, h3, h4, h5, h6 { margin: 0; padding: 0 }
    ul {list-style: none;}
    :focus { outline: none;}


    body{overflow: hidden;}
    main {
      max-width: 1500px;
      margin: 30px auto;
    }

    nav {
      height: 35px;
      background-color: antiquewhite;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 10px;
      font: 600 16px 'Fira Code','Source Code pro';

      --height:30px;
    }
    .game-setting > label{
      margin: 0 2px 0 5px;
      user-select: none;
    }
    .game-input{
      border:1px solid rgb(221, 183, 183);
    }
    #game-row,
    #game-columns,
    #mine{
      width: 3rem;
      height: calc(var(--height) - 5px);
      font: inherit;
      border: none;
      background-color: transparent;
    }
    .game-start,
    .game-over{
      width: 100px;
      height: var(--height);
      margin-left: 20px;
      font:inherit;
      color:rgb(47, 0, 255);
      border: none;
      border-radius: 5px;
      background-color: aqua;
      box-shadow:0 0 5px 1px currentColor;
      user-select: none;
    }
    .game-start:hover{
      color:rgb(225, 0, 255);
      background-color: rgb(251, 255, 0);
    }
    .game-over:hover{
      color:rgb(233, 233, 121);
      background-color: rgb(255, 0, 0);
    }
    .game-start:active,
    .game-over:active{
      box-shadow:inset 0 0 5px 2px currentColor;
    }

    /* æ¸¸æˆç›’å­ */
    .game-box {
      max-height: 700px;
      overflow: auto;
      padding: 10px;
      display: grid;
      gap: 5px;
      grid-row: repeat;
      place-content: start center;
      place-items: center;
      /* counter-increment: item; */
      user-select: none;
      font: 600 20px 'Dilan Whemsy';
      border:5px solid;
      border-image: linear-gradient(45deg, #CCFFFF, #FFCCCC) 10 30;
    }
    .game-box::-webkit-scrollbar{
      width : 5px;
      height: 10px;
      margin: 5px;
    }
    .game-box::-webkit-scrollbar-thumb {
      /*æ»šåŠ¨æ¡é‡Œé¢å°æ–¹å—*/
      border-radius: 10px;
      box-shadow   : inset 0 0 5px rgba(0, 0, 0, 0.2);
      background   : linear-gradient(45deg, #CCFFFF, #FFCCCC);
    }
    .game-box::-webkit-scrollbar-corner {
      border-radius: 2px;
      background-color: #FFCCCC;
    }
    .game-box::-webkit-scrollbar-track {
      /*æ»šåŠ¨æ¡é‡Œé¢è½¨é“*/
      box-shadow   : inset 0 0 5px rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      background   :linear-gradient(45deg, #FFCCCC, #CCFFFF);
    }
    .game-box>div {
      width: 100%;
      height: 100%;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      border: 1px solid black;
      /* counter-increment: item-count; */
      /* position: relative; */
    }

    .game-box>div:hover {
      background-color: aqua;
    }

    /* .game-box>div::after {
      width: auto;
      display: block;
      content: counter(item)'-'counter(item-count);
      color: red;
      position: absolute;
      left: -600px;
    } */
    .game-box>div.zero,
    .game-box>div.one,
    .game-box>div.two,
    .game-box>div.three,
    .game-box>div.four,
    .game-box>div.five,
    .game-box>div.six,
    .game-box>div.seven,
    .game-box>div.eight{
      border-color: #d9d9d9;
      background-color: #d9d9d9;
    }
    .game-box>div.one{color:#0332fe;}
    .game-box>div.two{color:#019f02;}
    .game-box>div.three{color:#ff2600}
    .game-box>div.four{color:#93208f;}
    .game-box>div.five{color:#ff7f29;}
    .game-box>div.six{color:#ff3fff;}
    .game-box>div.seven{color:#3fffbf;}
    .game-box>div.eight{color:#22ee0f;}
    .game-box>div.mine{
      border-color: #d9d9d9;
      background: #d9d9d9 url('./mine.png') no-repeat;
      background-position: center;
      background-size: 20px 20px;
    }
    .game-box>div.click-mine{
      background-color: red;
    }
    .flag{
      background: url('./flag.png') no-repeat;
      background-position: center;
      background-size: 20px 20px;
    }

    /* ä¿¡æ¯æ  */
    .info{
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 10px auto;
    }
    .game-state{
      width: auto;
      padding:5px;
      margin-right: 60px;
      border:5px solid;
      border-image: linear-gradient(45deg, #CCFFFF, #FFCCCC);
      border-image-slice: 10 30;
      background-image: linear-gradient(45deg, #ff00ff, #00ffff,
        #CCFFFF,  #FFCCCC, #6af5f5, #dbec76),
        linear-gradient(45deg, #ff00ff, #00ffff,
        #CCFFFF,  #FFCCCC, #6af5f5, #dbec76);
      -webkit-background-clip: text;
      background-clip: text,text;
      background-size:200% 200%,200% 200%;
      color: transparent;
      font: bold 20px 'Dilan Whemsy';
      user-select: none;
      animation: backmove 1s infinite linear;
    }
    .game-state:hover{border-image: linear-gradient(45deg, #f00, #f0f) 10 30; }
    @keyframes backmove {
      0%{background-position: 0 0,200% 200%;}
      100%{background-position: -200% 200%,0 0;}
    }
    .twinkle{
      border-image: none;
      animation: twinkle 1s infinite linear alternate;
    }
    @keyframes twinkle {
      0%{border-color: #f00; color: #0f0;}
      20%{border-color: #f0f; color: #00f;}
      40%{border-color: #0ff; color: #ff0;}
      60%{border-color: #ff0; color: #0ff;}
      80%{border-color: #00f; color: #f0f;}
      100%{border-color: #0f0; color: #f00;}
      /* 0%{border-image-source: linear-gradient(45deg, #f00, #f0f);}
      20%{border-image-source: linear-gradient(45deg, #0ff, #00f);}
      40%{border-image-source: linear-gradient(45deg, #ff0, #0f0);}
      60%{border-image-source: linear-gradient(45deg, #fff, #000);}
      80%{border-image-source: linear-gradient(45deg, #fc0cac, #da3ebe);}
      100%{border-image-source: linear-gradient(45deg, #d9d9d9, #ffc9c9);} */
    }
    .surplusMine {
      width: max-content;
      padding:5px;
      border: 1px solid black;
      text-align: center;
      margin-left: 60px;
    }
  </style>
  </head>
  
  <body>
    <main id="game-ui">
      <nav class="game-setting">
        <label for="game-row">æ¸¸æˆè§„æ ¼:</label>
        <div class="game-input">
          <input type="text" id="game-row" value="10" list="row">
          <datalist id="row">
            <option value="10"></option>
            <option value="15"></option>
            <option value="20"></option>
            <option value="25"></option>
          </datalist>
          <label for="game-columns">*</label>
          <input type="text" id="game-columns" disabled value="10">
        </div>
        <label for="mine">åœ°é›·æ•°é‡:</label>
        <input type="text" id="mine" value="15">
        <button type="button" class="game-start">é‡æ–°å¼€å§‹</button>
        <button type="button" class="game-over">æ”¾å¼ƒ</button>
      </nav>
      <div class="game-box">
  
      </div>
      <div class="info">
        <div class="game-state">æ¸¸æˆè¿›è¡Œä¸­!</div>
        <div class="surplusMine">å‰©ä½™é›·æ•°:<span class="mineNum"></span></div>
      </div>
    </main>
  
    <script>
      function Mine(rowColumn, mineNum) {
        this.rowColumn = rowColumn; //è¡Œå’Œåˆ—
        this.mineNum = mineNum; //é›·æ•°

        this.squares = []; //æ‰€æœ‰å•å…ƒæ ¼çš„ä½ç½®
        this.mine = []; //é›·çš„ä½ç½®
        this.cell = {};  //å•å…ƒæ ¼å¯¹è±¡
        this.surplusMine = mineNum; //å‰©ä½™é›·æ•°
        this.flag = [];   //æ ‡ä¸­çš„æ——å­
        this.allRight = false; //æ‰¾å‡ºçš„æ˜¯å¦å…¨æ˜¯é›·
        this.classColor = ['zero', 'one', 'two', 'three', 'four', 'five', 'six',
          'seven', 'eight', 'mine', 'click-mine']; //é¢œè‰²ç±»æ•°ç»„

        this.parent = document.querySelector('.game-box');
        this.surplus = document.querySelector('.mineNum');
      }
      Mine.prototype = {
        constructor: Mine,

        //åˆ›å»ºæ ¼å­
        createDom: function () {
          let dom = '',
            len = this.rowColumn;
          //åŒé‡å¾ªç¯æ˜¯ä¸ºäº†å–è¡Œå’Œåˆ—
          for (let i = 1; i <= len; i++) {
            // this.squares[i-1] = [];
            for (let j = 1; j <= len; j++) {
              //ä¿å­˜è¡Œåˆ—åæ ‡
              this.squares.push(i + '-' + j);
              dom += `<div data-id="${i}-${j}"></div>`;
            }
          };
          //è®¾ç½®ç½‘æ ¼å¸ƒå±€
          // debugger
          let str = `grid-template-rows: repeat(${this.rowColumn}, 32px);
          grid-template-columns: repeat(${this.rowColumn}, 32px);`
          // console.log(this.parent.style);
          this.parent.style.cssText += str;
          this.parent.innerHTML = dom;
        },

        //åˆ›å»ºéšæœºé›·
        createMine: function () {
          //æ‹·è´æ•°ç»„  ä¸ç”¨æ‹·è´
          // let arr = Array.apply(null, this.squares);
          //éšæœºæ’åºæ•°ç»„
          this.squares.sort(function () { return 0.5 - Math.random() });
          //æˆªå–é›·çš„ä½ç½®æ•°ç»„   å¹¶å°†å…ƒæ•°ç»„å‰”é™¤é›·
          this.mine = this.squares.splice(0, this.mineNum);
        },

        //å–å¾—å•å…ƒæ ¼æ—è¾¹çš„å…«ä¸ªå•å…ƒæ ¼
        calcEight: function (cell) {
          let r = cell.row,
            c = cell.column,
            calcEight = [];
          /*
          *  r-1,c-1   r-1,c   r-1,c+1
          * r,c-1     r,c     r,c+1
          * r+1,c-1   r+1,c   r+1,c+1
          */
          // debugger;
          for (let i = r - 1; i <= r + 1; i++) {
            for (let j = c - 1; j <= c + 1; j++) {
              let str = i + '-' + j;
              //ç­›é€‰å­˜åœ¨ä¸”ä¸ä¸ºè‡ªèº«çš„
              if (this.cell[str] && this.cell[str] != cell) {
                calcEight.push(str);
              }
            }
          }
          cell.roundCell = calcEight;
        },

        //ä¸ºå•å…ƒæ ¼å¯¹è±¡æ·»åŠ å±æ€§
        cellAddProperty: function () {
          //åˆ›å»ºæ‰€æœ‰å•å…ƒæ ¼çš„å±æ€§
          for (let i = this.squares.length - 1; i >= 0; i--) {
            let rc = this.squares[i].split('-');
            this.cell[this.squares[i]] = { mine: false, value: 0, row: ~~rc[0], column: ~~rc[1], show: false };
          }

          //å–å¾—å‘¨å›´çš„æ ¼å­,å¹¶è·å–è‡ªèº«å¯¹åº”çš„domå…ƒç´ 
          for (let k in this.cell) {
            this.calcEight(this.cell[k]);
            let div = document.querySelector(`[data-id="${k}"]`);
            div.classList.add
            //éšè—ä½ç½®ä¿¡æ¯
            div.pos = div.dataset.id;
            div.removeAttribute('data-id');
            this.cell[k].dom = div;
          }

          //åˆ›å»ºé›·
          this.createMine();

          //æ›´æ–°å•å…ƒæ ¼æ˜¯å¦ä¸ºé›·
          for (let i = this.mine.length - 1; i >= 0; i--) {
            let cell = this.cell[this.mine[i]];
            cell.mine = true;
            //æ›´æ–°é›·æ—è¾¹å•å…ƒæ ¼çš„æ•°å€¼
            for (let j = cell.roundCell.length - 1; j >= 0; j--) {
              this.cell[cell.roundCell[j]].value++;
            }
          }
        },

        //æ¸²æŸ“æ•°æ®ç”¨äºæ£€æŸ¥
        // showValue: function () {
        //   for (let k in this.cell) {
        //     if (this.cell[k].mine) {
        //       this.cell[k].dom.innerText = 'é›·';
        //     } else {
        //       this.cell[k].dom.innerText = this.cell[k].value;
        //     }
        //   }
        // },

        //å…¥å£
        init: function () {
          //åˆ›å»ºdom
          this.createDom();

          //åˆ›å»ºå•å…ƒæ ¼å¯¹è±¡å±æ€§
          this.cellAddProperty();

          //æ›´æ–°æ¸¸æˆçŠ¶æ€
          Nice.gameState.innerText = 'æ¸¸æˆè¿›è¡Œä¸­!'

          //æ ‡è¯†å‰©ä½™é›·æ•°
          this.surplus.innerText = this.surplusMine;
          // this.showValue();
          // console.log(this.mine);
        },


        //é€’å½’å±•å¼€
        zeroshow: function (cell) {
          // debugger;
          cell.dom.classList.add(this.classColor[cell.value]);
          cell.show = true;
          for (let i = cell.roundCell.length - 1; i >= 0; i--) {
            let c = this.cell[cell.roundCell[i]];
            if (c.mine || c.show || c.flag) { continue; }
            if (c.value == 0) {
              this.zeroshow(c);
            } else {
              c.show = true;
              this.showNum(c);
            }
          }
        },

        //æ˜¾ç¤ºæ•°å­—
        showNum: function (cell) {
          cell.dom.innerText = cell.value;
          cell.dom.classList.add(this.classColor[cell.value]);
        },

        //æ˜¾ç¤ºé›·
        showMine: function () {
          for (let i = this.mine.length - 1; i >= 0; i--) {
            let c = this.cell[this.mine[i]];
            c.show = true;
            c.dom.className = this.classColor[this.classColor.length - 2];
          }
        },

        //æ¸¸æˆç»“æŸ
        gameOver: function (cell) {

          //æ˜¾ç¤ºæ‰€æœ‰çš„é›·
          this.showAll(true);

          //ç‚¹ç§çš„é›·æ ‡çº¢
          if (cell) {
            cell.dom.classList.add(this.classColor[this.classColor.length - 1]);
          }
          //åœæ­¢æ¸¸æˆ
          Nice.gameOver = true;
          //æ›´æ–°æ¸¸æˆçŠ¶æ€
          Nice.gameState.innerText = 'æ¸¸æˆç»“æŸ!';
          Nice.clearMessage();
          Nice.messageAlert('ä½ å¤±è´¥äº†!');
        },

        //å±•å¼€æ‰€æœ‰æ ¼å­
        showAll: function (showMine) {

          //æ˜¯å¦å±•å¼€é›·
          if (showMine) {
            this.showMine();
          }

          //å±•å¼€æ‰€æœ‰æ ¼å­
          for (let i = this.squares.length - 1; i >= 0; i--) {
            let c = this.cell[this.squares[i]];
            if (c.mine || c.show) { continue; }
            if (c.value == 0) {
              c.dom.classList.add(this.classColor[c.value]);
            } else {
              this.showNum(c);
            }
          }
        },

        //ç‚¹å‡»äº‹ä»¶
        leftClick: function (domId) {
          let cell = this.cell[domId];
          if (cell.show || cell.flag) { return; }
          cell.show = true;
          if (cell.mine) {
            this.gameOver(cell);
          } else {
            if (cell.value == 0) {
              this.zeroshow(cell);
            } else {
              this.showNum(cell);
            }
          }
          console.log(cell.dom);
        },

        rightClick: function (domId) {
          let cell = this.cell[domId];
          if (cell.show) { return; }
          if (cell.flag) {
            cell.flag = false;
            //ä»æ——å­æ•°ç»„é‡Œé¢åˆ é™¤
            this.flag.splice(this.flag.indexOf(domId), 1);
            cell.dom.classList.remove('flag');
            this.surplus.innerText = ++this.surplusMine;
          } else {
            cell.flag = true;
            //åŠ å…¥æ——å­æ•°ç»„
            this.flag.push(domId);
            cell.dom.classList.add('flag');
            // console.log(cell.dom);
            this.surplus.innerText = --this.surplusMine;
          }

          //åˆ¤æ–­èƒœè´Ÿ
          if (this.surplusMine == 0) {
            for (let k in this.flag) {
              if (!this.cell[this.flag[k]].mine) {
                this.gameOver();
                return;
              }
            }
            this.showAll();
            //åœæ­¢æ¸¸æˆ
            Nice.gameOver = true;
            //æ›´æ–°æ¸¸æˆçŠ¶æ€
            Nice.gameState.innerText = 'æ¸¸æˆèƒœåˆ©!';
            Nice.clearMessage();
            Nice.messageAlert('ä½ èƒœåˆ©äº†!');
          }
        }
      };

      let Nice = (function () {
        let game = {};
        game.gameOver = false;
        let startbut = document.querySelector('.game-start'),
          row = document.querySelector('#game-row'),
          columns = document.querySelector('#game-columns'),
          mine = document.querySelector('#mine'),
          gameBox = document.querySelector('.game-box'),
          gameOver = document.querySelector('.game-over');
        game.gameState = document.querySelector('.game-state');
        game.timeId = 0; //è®¡æ—¶å™¨id

        function startGame(r, m) {
          game.clearMessage();
          game.play = new Mine(r, m);
          game.play.init();
        }

        function play(ev) {
          // console.log(ev.target);//äº‹ä»¶ç›®æ ‡
          // console.dir(ev);//äº‹ä»¶å¯¹è±¡
          // console.log('æŒ‰ä¸‹çš„é”®'+ev.which);
          let target = ev.target;
          switch (true) {
            case ev.which == 1: {
              if (target.pos) {
                //æ¸¸æˆç»“æŸåäº‹ä»¶ä¸å‘ç”Ÿ
                if (game.gameOver) { return; }
                game.play.leftClick(target.pos);
              }
              break;
            }
            case ev.which == 3: {
              if (target.pos) {
                //æ¸¸æˆç»“æŸåäº‹ä»¶ä¸å‘ç”Ÿ
                if (game.gameOver) { return; }
                game.play.rightClick(target.pos);
              }
              break;
            }
          }
        }

        function change(ev) {
          // console.dir(ev);
          // debugger;
          if (ev.type == 'keypress') {
            /\d/.test(ev.key) ? ev.key : ev.preventDefault();
          }
          switch (true) {
            case ev.target == row: {
              // debugger;
              columns.value = row.value;
              mine.value = ~~(columns.value * columns.value * 0.15);
              break;
            }
            case ev.target == mine: {
              if (mine.value > (columns.value * columns.value)) {
                game.clearMessage();
                game.messageAlert('åœ°é›·çš„æ•°é‡ä¸èƒ½å¤§ä¸æ¸¸æˆè§„æ ¼!');
                mine.value = 15;
              }
              break;
            }
          }
        }

        //æç¤ºæå‰å–æ¶ˆ
        game.clearMessage = function () {
          clearTimeout(game.timeId);
          this.gameState.classList.remove('twinkle');
        };
        //æ¶ˆæ¯æç¤º
        game.messageAlert = function (str) {
          // debugger;
          this.gameState.classList.add('twinkle');
          let message = this.gameState.innerText,
            that = this;
          if (str) {
            this.gameState.innerText = str;
          }

          game.timeId = setTimeout(function () {
            that.gameState.classList.remove('twinkle');
            that.gameState.innerText = message;
          }, 3000);
        }

        //äº‹ä»¶
        game.start = function () {
          //å¼€å§‹æ¸¸æˆ
          startGame(10, 15);
          startbut.onclick = function () {
            // debugger;
            let m = ~~mine.value;
            let rc = ~~columns.value;
            if (m <= 0) {
              game.clearMessage();
              game.messageAlert("ä¸€ä¸ªåœ°é›·ä¸è¦,ä½ ç©ä¸ªé”¤å­ç©ğŸ”¨!");
              return false;
            }
            if(rc >= 40){
              gameBox.style = 'place-content: start;';
            }else{
              gameBox.style = '';
            }
            startGame(rc, m);
            game.gameOver = false;
          };
          //æ”¾å¼ƒæ¸¸æˆ
          gameOver.onclick = function () {
            game.play.showAll(true);
            game.gameState.innerText = 'æ¸¸æˆç»“æŸ';
            game.gameOver = true;
          }

          //ç»‘å®šäº‹ä»¶
          document.addEventListener('mousedown', play, false);
          document.addEventListener('change', change, false);
          document.addEventListener('keypress', change, false);
          document.addEventListener('keyup', change, false);
          //å–æ¶ˆå³é”®èœå•
          // document.addEventListener('contextmenu',function(e){e.preventDefault();},false);
          document.oncontextmenu = function (e) { return false; };
          document.ondragstart = function (e) { return false; };
        }
        return game;
      })();
      // let a = new Mine(10, 25);
      // a.init();
      Nice.start();
    </script>
  </body>
  
  </html>